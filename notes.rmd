---
title: "Notes from *Introduction to Empirical Bayes*"
author: "Peter Lukacs"
output:
    html_document:
        fig_width: 7
        fig_height: 5
        fig_align: center
---

```{r "load-packages", echo=FALSE, warning=FALSE}
source('global.R')

theme_set(theme_light())
```

# I Empirical Bayes

## 2 The beta distribution

  + The beta distribution is a probability distribution with two parameters `alpha` and `beta`, constrained to between 0 and 1.

```{r "beta-distro-plot", echo=FALSE}
beta_distro_params <- data.frame(a = c(1, 3, 20, 50), b = c(2, 3, 20, 10))
beta_distro_dt <- as.data.table(merge(beta_distro_params, x = seq(0, 1, 0.001), all = TRUE)) %>%
    .[, beta_density_value := dbeta(x, a, b), by = .(x, a, b)] %>%
    .[, Parameters := sprintf("a: %d, b: %d", a, b)]
ggplot(beta_distro_dt, aes(x, beta_density_value, color = Parameters)) +
    geom_line() +
    scale_y_continuous(name = "Density of beta") +
    ggtitle("The beta distribution")
```

  + **Batting average** is an important baseball statistics which is calculated as the number of **hits (H)** divided by the number of **at-bats (AB)**. A player's batting average is always between 0 and 1 and can be represented with the beta distribution.

  \[Batting\ Average = \frac{H}{AB}\]

  + If a player starts out with a single or a strike out we wont't predict that his BA will be 1 or 0. This is because we've seen in the history that players tend to have a BA between .270 and .300, thus we have *prior expectations*.

  > The number of hits a player gets out of his at-bats is an example of a **binomial distribution**, which models a count of successes out of a total. Since it's a binomial, the best way to represent the prior expectations is with the beta distribution.

  > This is the Bayesian philosophy in a nutshell: we start with a prior distribution, see some evidence, then update to a **posterior** distribution.

  + Update the beta distribution this way:
  \[Beta(\alpha_0 + hits,\ \beta_0 + misses)\]

  + Below is an example of a player: first, our prior expectation about him is that he will have around .27 BA ($Beta(81, 219)$). After this, he hits the ball once out of one, so we update his posterior distribution to $Beta(82, 219)$, a tiny change. Later he will be up to bat 300 times and hits the ball a 100 times out of that, updating his beta to $Beta(181, 419)$.

```{r "beta-distro-update-plot", echo=FALSE}
beta_distro_params <- data.frame(a = c(81, 82, 181), b = c(219, 219, 419))
beta_distro_dt <- as.data.table(merge(beta_distro_params, x = seq(0, .5, 0.001), all = TRUE)) %>%
    .[, beta_density_value := dbeta(x, a, b), by = .(x, a, b)] %>%
    .[, Parameters := sprintf("a: %d, b: %d", a, b)]
ggplot(beta_distro_dt, aes(x, beta_density_value, color = Parameters)) +
    geom_line() +
    scale_color_manual(values = c('dodgerblue', 'green3', 'violetred')) +
    scale_y_continuous(name = "Density of beta") +
    ggtitle("The updated beta distribution") +
    labs(x = "Batting Average") +
    theme_light()
```

  + **Posterior mean** is the expected value of the resulting beta distribution which we can use as our new estimate.
  \[E(Beta(\alpha, \beta)) = \frac{\alpha}{\alpha + \beta}\]
  + With the above example you can see that our posterior expectation is higher than our prior but lower than our expectation based on the actual inspected hits and misses:
  \[\frac{81}{81 + 219} < \frac{182}{182 + 419} < \frac{100}{100 + 200}\]

  + Imagine that our objective is to assess a player who we've seen hit 100/300. We can't take every person with the exact stats and see how they did historically but we can do a simulation:
```{r "simulate-100/300-player"}
num_trials <- 10e6

# Take 10mm players whose betting average produces a Beta(81, 219)
# Then, simulate how well they'd do if they tried to hit the ball 300 times
simulations <- data_frame(
  true_average = rbeta(num_trials, 81, 219),
  hits = rbinom(num_trials, 300, true_average)
)

simulations

# Now filter for those who hit exactly 100/300 and then plot their true average distribution
hit_100 <- simulations %>%
  filter(hits == 100)
```

```{r "hit-100-plot", echo=FALSE, warning=FALSE}
ggplot(hit_100, aes(true_average)) +
  geom_freqpoly()
```


# II Hypothesis testing
